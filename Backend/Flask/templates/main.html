<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart AI Traffic Management - Vadodara</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      background-color: #f4f6f9;
      font-family: 'Segoe UI', sans-serif;
    }
    .sidebar {
      height: 100vh;
      background: #1e1e2f;
      color: #fff;
      position: fixed;
      width: 250px;
      overflow-y: auto; /* Enable scrolling for long content */
    }
    .sidebar a {
      color: #ccc;
      text-decoration: none;
      display: block;
      padding: 12px 20px;
      border-left: 3px solid transparent;
      transition: all 0.3s;
    }
    .sidebar a:hover, .sidebar a.active {
      background: #2a2a3f;
      border-left-color: #007bff;
      color: #fff;
    }
    .sidebar .navbar-brand {
      padding: 20px;
      font-size: 1.5em;
      text-align: center;
      color: #fff;
      border-bottom: 1px solid #333;
      margin-bottom: 15px;
    }
    .content {
      margin-left: 250px;
      padding: 20px;
      background-color: #f4f6f9;
      min-height: 100vh;
    }
    .card {
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }
    .card-header {
      background-color: #007bff;
      color: white;
      font-weight: bold;
      border-radius: 8px 8px 0 0;
    }
    .map-container {
      height: 400px;
      border-radius: 8px;
      overflow: hidden;
    }
    .marker-popup {
      font-weight: bold;
    }
    .form-label {
      font-weight: bold;
    }
    .btn-primary {
      background-color: #007bff;
      border-color: #007bff;
    }
    .btn-primary:hover {
      background-color: #0056b3;
      border-color: #0056b3;
    }
    .alert-info {
      background-color: #e0f7fa;
      border-color: #b2ebf2;
      color: #00796b;
    }
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1050;
    }
    .toast {
      background-color: #fff;
      border: 1px solid rgba(0,0,0,.05);
      box-shadow: 0 .25rem .75rem rgba(0,0,0,.1);
    }
    .voice-assistant-output {
      min-height: 100px;
      background-color: #e9ecef;
      padding: 15px;
      border-radius: 5px;
      white-space: pre-wrap;
      overflow-y: auto;
      margin-top: 15px;
    }
    .btn-danger {
      background-color: #dc3545;
      border-color: #dc3545;
    }
    .btn-danger:hover {
      background-color: #c82333;
      border-color: #bd2130;
    }
    .btn-warning {
      background-color: #ffc107;
      border-color: #ffc107;
      color: #212529;
    }
    .btn-warning:hover {
      background-color: #e0a800;
      border-color: #d39e00;
    }
    .content-section {
      display: none; /* Hidden by default */
    }
    .content-section.active {
      display: block; /* Shown when active */
    }
    
    /* Styles specific to Signal Predictor */
    .signal-predictor-card {
      max-width: 600px;
      margin: 20px auto;
      padding: 25px;
    }
    .signal-predictor-card h2 {
      text-align: center;
      margin-bottom: 25px;
      color: #343a40;
    }
    .signal-predictor-card label {
      font-weight: bold;
      margin-top: 10px;
      margin-bottom: 5px;
      display: block;
    }
    .signal-predictor-card select,
    .signal-predictor-card input[type="range"],
    .signal-predictor-card button {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 5px;
      border: 1px solid #ced4da;
    }
    .signal-predictor-card input[type="range"] {
      padding: 0;
    }
    .signal-predictor-card .range-value {
      text-align: center;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .signal-predictor-card .btn-predict {
      background-color: #28a745;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 1.1em;
      padding: 12px;
    }
    .signal-predictor-card .btn-predict:hover {
      background-color: #218838;
    }
    #signalPredictionResults {
      margin-top: 30px;
      border-top: 1px solid #eee;
      padding-top: 20px;
      text-align: center;
    }
    .signal-prediction-result-item {
      margin-bottom: 10px;
    }
    .signal-prediction-result-label {
      font-weight: bold;
      color: #007bff;
    }
    .signal-prediction-result-value {
      font-size: 1.1em;
      color: #343a40;
    }
    .bar-chart {
      display: flex;
      justify-content: space-around;
      align-items: flex-end;
      height: 200px;
      border-bottom: 1px solid #ccc;
      margin-top: 20px;
      padding-bottom: 5px;
      position: relative; /* For positioning labels */
    }
    .bar {
      width: 60px;
      background-color: #007bff;
      color: white;
      text-align: center;
      font-weight: bold;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      transition: height 0.5s ease-out;
      position: relative;
      margin: 0 5px; /* Spacing between bars */
    }
    .bar span {
      position: absolute;
      top: -20px;
      color: #333;
      font-size: 0.9em;
    }
    .bar-label {
      position: absolute;
      bottom: -25px;
      font-size: 0.8em;
      color: #555;
      width: 100%; /* Ensure label is centered under bar */
    }
    .bar.green { background-color: #2ecc71; }
    .bar.red { background-color: #e74c3c; }
    .bar.yellow { background-color: #f1c40f; }
    
    footer {
      background-color: #1e1e2f;
      color: #ccc;
      text-align: center;
      padding: 10px 10px;
      margin-top: auto;
    }
    
    footer a {
      color: #f8f9fa;
      text-decoration: none;
    }
    
    footer a:hover {
      text-decoration: underline;
    }
    
    /* News Section Styling */
    .live-news-section {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }
    
    .live-news-header {
      padding: 15px 20px;
      background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%); /* Blue/Dark gradient */
      color: white;
      font-size: 1.2em;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      border-radius: 8px 8px 0 0;
    }
    
    .live-news-header i {
      color: #f1c40f; /* Yellow bell icon */
    }
    
    .news-list-container {
      max-height: 350px; /* Limit height */
      overflow-y: auto; /* Enable scrolling if content exceeds height */
      padding-right: 15px; /* Space for scrollbar */
    }
    
    .news-item {
      padding: 10px 0;
      border-bottom: 1px dashed #eee;
    }
    
    .news-item:last-child {
      border-bottom: none; /* No border for the last item */
    }
    
    .news-item h6 {
      margin-bottom: 5px;
      font-size: 1em;
    }
    
    .news-item a {
      color: #007bff;
      text-decoration: none;
      font-weight: bold;
    }
    
    .news-item a:hover {
      text-decoration: underline;
    }
    
    .news-item p.summary {
      font-size: 0.85em;
      color: #666;
      margin-bottom: 5px;
    }
    
    .news-item p.published {
      font-size: 0.75em;
      color: #999;
      text-align: right;
    }
    
    /* Optional styling to make modal wider when triggered from sidebar */
    #reportHazardModal .modal-dialog {
      max-width: 600px;
    }
    
    
    
    
    /* --- NEW WATER LOGGING ALERT STYLES --- */
    .water-logging-card {
      border: 1px solid #ffc107; /* Warning color */
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 15px;
      background-color: #fff3cd; /* Light warning background */
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .water-logging-card img {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    .water-logging-card .location-name {
      font-weight: bold;
      color: #856404; /* Darker warning text */
    }
    .water-logging-card .alert-message {
      font-size: 0.9em;
      color: #856404;
    }
    
    
  </style>
</head>
<body>
  <div class="sidebar">
    <a class="navbar-brand" href="#">Smart Traffic Hub</a>
    <ul class="navbar-nav" id="sidebar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="#dashboard-content" data-target="dashboard-content">
          <i class="fas fa-tachometer-alt"></i> Dashboard
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#traffic-suggestion-content" data-target="traffic-suggestion-content">
          <i class="fas fa-route"></i>  Route Suggestion
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#peak-hours-content" data-target="peak-hours-content">
          <i class="fas fa-car-side"></i> Peak Hours Travel Suggestion
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#emergency-route-content" data-target="emergency-route-content">
          <i class="fas fa-ambulance"></i> Emergency Route Finder
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#signal-prediction-content" data-target="signal-prediction-content">
          <i class="fas fa-traffic-light"></i> Traffic Signal Timing
        </a>
      </li>
      
      <li class="nav-item">
        <a class="nav-link" href="#smart-route-planner-content" data-target="smart-route-planner-content">
          <i class="fas fa-route"></i> Smart Route Planner
        </a>
      </li>
      
      
      <!--Water Logging  System -->
      <li class="nav-item">
        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#reportHazardModal">
          <i class="fas fa-exclamation-triangle"></i> Report Water Hazard
        </a>
      </li>
      
      <li class="nav-item">
        <a class="nav-link" href="#voice-assistant-content" data-target="voice-assistant-content">
          <i class="fas fa-microphone"></i> Voice Assistant
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#alerts-content" data-target="alerts-content">
          <i class="fas fa-bell"></i> Alerts
        </a>
      </li>
    </ul>
  </div>
  
  
  <!--Dash board Layout -->
  <div class="content">
    <div class="main-content">
      <div id="dashboard-content" class="content-section active">
        <div class="card">
          <div class="card-header">Dashboard Overview</div>
          <div class="card-body">
            <p>Welcome to the Smart AI Traffic Management System for Vadodara.</p>
            <div id="map" class="map-container"></div>
          </div>
        </div>
        <!--------------------------------------------------------------Live News Section ---------------------------------------------->
        <div class="card mt-4 live-news-section">
          <div class="card-header live-news-header">
            <i class="fas fa-bullhorn"></i> Live Vadodara News
          </div>
          <div class="card-body">
            <div id="newsListContainer" class="news-list-container">
              <p>Loading Vadodara news...</p>
            </div>
          </div>
        </div>
      </div>
      
      
      
      
      
      
      
      
      <div id="traffic-suggestion-content" class="content-section">
        <div class="card">
          <div class="card-header"> Route Suggestion</div>
          <div class="card-body">
            <div class="mb-3">
              <label for="originInput" class="form-label">Origin:</label>
              <input type="text" class="form-control" id="originInput" placeholder="Enter origin" value="Your current location" />
            </div>
            <div class="mb-3">
              <label for="destinationInput" class="form-label">Destination:</label>
              <input type="text" class="form-control" id="destinationInput" placeholder="Enter destination" />
            </div>
            <button id="getRouteBtn" class="btn btn-primary">Get Route</button>
            <div id="routeResult" class="mt-3"></div>
            <div id="routeMap" class="map-container mt-3" style="height: 300px;"></div>
          </div>
        </div>
      </div>
      
      <div id="peak-hours-content" class="content-section">
        <div class="card">
          <div class="card-header">Peak Hours Travel Suggestion</div>
          <div class="card-body">
            <div class="mb-3">
              <label for="peakHoursLocationSelect" class="form-label">Location:</label>
              <select class="form-select" id="peakHoursLocationSelect">
              </select>
            </div>
            <div class="mb-3">
              <label for="peakHoursRoadTypeSelect" class="form-label">Road Type:</label>
              <select class="form-select" id="peakHoursRoadTypeSelect">
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Day Type:</label>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="dayType" id="dayTypeWeekday" value="0" checked>
                <label class="form-check-label" for="dayTypeWeekday">
                  Weekday
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="dayType" id="dayTypeWeekend" value="1">
                <label class="form-check-label" for="dayTypeWeekend">
                  Weekend
                </label>
              </div>
            </div>
            <button id="getPeakHoursReportBtn" class="btn btn-primary">Get Travel Suggestion</button>
            
            <div id="peakHoursReportResult" class="mt-4">
            </div>
            
            <div id="hourlyPredictionsChart" class="bar-chart mt-4" style="height: 250px;">
            </div>
          </div>
        </div>
      </div>
      
      <div id="emergency-route-content" class="content-section">
        <div class="card">
          <div class="card-header">Emergency Route Finder</div>
          <div class="card-body">
            <p>Find the fastest route to the nearest hospital based on your current location.</p>
            <button id="findEmergencyRouteBtn" class="btn btn-danger">Find Emergency Route</button>
            <div id="emergencyRouteResult" class="mt-3"></div>
            <div id="emergencyMap" class="map-container mt-3" style="height: 300px;"></div>
          </div>
        </div>
      </div>
      
      <div id="signal-prediction-content" class="content-section">
        <div class="card signal-predictor-card">
          <h2><i class="fas fa-traffic-light"></i> Traffic Signal Timing Predictor</h2>
          
          <div>
            <label for="signalLocationSelect"><i class="fas fa-map-marker-alt"></i> Location:</label>
            <select id="signalLocationSelect" class="form-select">
            </select>
          </div>
          
          <div>
            <label for="signalHourRange"><i class="far fa-clock"></i> Hour: <span id="signalHourValue" class="range-value">9</span></label>
            <input type="range" id="signalHourRange" min="0" max="23" value="9" />
          </div>
          
          <div>
            <label><i class="far fa-calendar-alt"></i> Day Type:</label>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="signalDayType" id="signalWeekdayRadio" value="Weekday" checked>
              <label class="form-check-label" for="signalWeekdayRadio">
                Weekday
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="signalDayType" id="signalWeekendRadio" value="Weekend">
              <label class="form-check-label" for="signalWeekendRadio">
                Weekend
              </label>
            </div>
          </div>
          
          <button id="predictSignalButton" class="btn btn-predict"><i class="fas fa-play-circle"></i> Predict Signal Timing</button>
          
          <div id="signalPredictionResults">
            <div class="bar-chart" id="signalChart">
            </div>
          </div>
        </div>
      </div>
      
      <div id="voice-assistant-content" class="content-section">
        <div class="card">
          <div class="card-header">Voice Assistant</div>
          <div class="card-body text-center">
            <p>Click the microphone and speak your command (e.g., "Navigate to Sursagar Lake" or "How is traffic near Akota").</p>
            <button id="micBtn" class="btn btn-danger btn-lg rounded-circle" style="width: 80px; height: 80px;">
              <i class="fas fa-microphone"></i>
            </button>
            <div id="voiceStatus" class="voice-assistant-output mt-3">Click the microphone to speak.</div>
          </div>
        </div>
      </div>
      
      <div id="alerts-content" class="content-section">
        <div class="card">
          <div class="card-header">Traffic Alerts</div>
          <div class="card-body" id="alertsList">
            <p>Loading alerts...</p>
          </div>
        </div>
      </div>
      
      
      
      
      
      <!---- Section For Smart Rout Planner New Feature : -->
      <div id="smart-route-planner-content" class="content-section ">
        <div class="card mt-4 mb-4">
          <div class="card-header bg-primary text-white">
            <h5><i class="fas fa-route"></i> Smart Route Planner</h5>
          </div>
          <div class="card-body">
            <form id="smartRouteForm" >
              <div class="mb-3">
                <label for="startNodeInput" class="form-label">Start Node:</label>
                <input type="text" class="form-control" id="startNodeInput" placeholder="e.g., Nizampura" required>
              </div>
              <div class="mb-3">
                <label for="endNodeInput" class="form-label">End Node:</label>
                <input type="text" class="form-control" id="endNodeInput" placeholder="e.g., Subhanpura" required>
              </div>
              <div class="mb-3">
                <label for="hourInput" class="form-label">Hour (0-23):</label>
                <input type="number" class="form-control" id="hourInput" placeholder="e.g., 9 for 9 AM" min="0" max="23" required>
              </div>
              <button type="submit" class="btn btn-success"><i class="fas fa-search-location"></i> Get Smart Route</button>
            </form>
            
            <div id="smartRouteResults" class="mt-4" style="display: none;">
              <h6>Route Details:</h6>
              <div class="card card-body bg-light">
                <p><strong>Total Distance:</strong> <span id="routeDistance"></span> km</p>
                <p><strong>Estimated Time:</strong> <span id="routeTime"></span> minutes</p>
                <p><strong>Path:</strong> <span id="routePath"></span></p>
              </div>
              <section id="reportHazardSection" class="card shadow-sm p-4 mb-4  bg-light">
                  <h4> Water Hazard Report</h4>
                </section>
            </div>
            <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 11"></div>
            <div id="smartRouteError" class="alert alert-danger mt-4" style="display: none;"></div>
            <div id="waterLoggingAlertsContainer" class="row mt-4" style="display:none;">
              <h4 class="mb-3">Water Logging Alerts on Route:</h4>
            </div>
            
          </div>
        </div>
      </div> 
      
      
      
      
      
    </div>
  </div>
  
  
  
  
  <!-- Water Logging Report  -->
  
  <div class="modal fade" id="reportHazardModal" tabindex="-1" aria-labelledby="reportHazardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="reportHazardModalLabel">Report Water Hazard</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="waterHazardReportForm" action="/report-water-hazard" method="POST" enctype="multipart/form-data">
            
            
            <div class="mb-3">
              <label for="locationNameInput" class="form-label">Location Name (e.g., "Akota Bridge")</label>
              <input type="text" class="form-control" id="locationNameInput" name="location_name" placeholder="Enter a location or landmark">
            </div>
            <div class="mb-3">
              <label for="imageInput" class="form-label">Upload Image</label>
              <input type="file" class="form-control" id="imageInput" name="hazard_image" accept="image/*" required>
              <small class="form-text text-muted">Please upload a clear image of the waterlogging.</small>
            </div>
            <input type="hidden" id="latitudeInput" name="latitude">
            <input type="hidden" id="longitudeInput" name="longitude">
            <button type="button" class="btn btn-primary" id="getGPSLocationBtn">Get Current GPS Location</button>
            <div id="gpsStatus" class="form-text text-muted mt-2"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-success" form="waterHazardReportForm">Submit Report</button>
        </div>
      </div>
    </div>
  </div>
  
  
  <!-- notification Section-->
  
  <div class="toast-container"></div>
  <button class="btn current-location-btn" id="current-location-btn" title="Go to my current location">
    <i class="fas fa-crosshairs"></i>
  </button>
  
  <!-- Footer Section-->
  <footer>
    <div>© 2025 Smart Traffic Management | Built with ❤️ for smarter cities</div>
  </footer>
  
  
  
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let map = null; // Declare map globally
    let routeMap = null;
    let emergencyMap = null;
    
    document.addEventListener('DOMContentLoaded', () => {
      // Sidebar Navigation Logic
      const sidebarNav = document.getElementById('sidebar-nav');
      const contentSections = document.querySelectorAll('.content-section');
      
      sidebarNav.addEventListener('click', (event) => {
        if (event.target.tagName === 'A' || event.target.closest('A')) {
          event.preventDefault();
          const link = event.target.tagName === 'A' ? event.target : event.target.closest('A');
          const targetId = link.dataset.target;
          
          // Remove active class from all links and hide all sections
          document.querySelectorAll('.nav-link').forEach(navLink => navLink.classList.remove('active'));
          contentSections.forEach(section => section.classList.remove('active'));
          
          // Add active class to clicked link and show target section
          link.classList.add('active');
          const targetSection = document.getElementById(targetId);
          if (targetSection) {
            targetSection.classList.add('active');
          }
          
          // Special handling for maps to re-render
          if (targetId === 'dashboard-content' && map === null) {
            initializeMap('map');
          } else if (targetId === 'traffic-suggestion-content' && routeMap === null) {
            initializeMap('routeMap');
          } else if (targetId === 'emergency-route-content' && emergencyMap === null) {
            initializeMap('emergencyMap');
          }
          // Invalidate size for leaflet maps when their containers become visible
          if (map && targetId === 'dashboard-content') map.invalidateSize();
          if (routeMap && targetId === 'traffic-suggestion-content') routeMap.invalidateSize();
          if (emergencyMap && targetId === 'emergency-route-content') emergencyMap.invalidateSize();
        }
      });
      
      // Initialize Dashboard map on page load
      initializeMap('map');
      
      // Fetch and display Vadodara news on dashboard load
      fetchAndDisplayVadodaraNews(); 
      
      // --- Map Functions (Unified) ---
      function initializeMap(mapId) {
        if (document.getElementById(mapId) && (mapId === 'map' && map === null || mapId === 'routeMap' && routeMap === null || mapId === 'emergencyMap' && emergencyMap === null)) {
          const newMap = L.map(mapId).setView([22.3072, 73.1812], 13); // Vadodara coordinates
          
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          }).addTo(newMap);
          
          if (mapId === 'map') map = newMap;
          else if (mapId === 'routeMap') routeMap = newMap;
          else if (mapId === 'emergencyMap') emergencyMap = newMap;
          
          return newMap;
        }
        return mapId === 'map' ? map : (mapId === 'routeMap' ? routeMap : emergencyMap);
      }
      
      let currentLocationMarker = null;
      let routeLine = null;
      let emergencyRouteLine = null;
      let trafficMarkers = [];
      let alertMarkers = [];
      
      function addMarker(mapInstance, lat, lng, title, color = 'blue') {
        const markerHtmlStyles = `
        background-color: ${color};
        width: 2rem;
        height: 2rem;
        display: block;
        left: -1rem;
        top: -1rem;
        position: relative;
        border-radius: 2rem 2rem 0;
        transform: rotate(45deg);
        border: 1px solid #FFFFFF;
        `;
        const icon = L.divIcon({
          className: "my-custom-pin",
          iconAnchor: [0, 24],
          popupAnchor: [0, -36],
          html: `<span style="${markerHtmlStyles}" />`
        });
        const marker = L.marker([lat, lng], { icon: icon }).addTo(mapInstance);
        if (title) {
          marker.bindPopup(`<b class="marker-popup">${title}</b>`);
        }
        return marker;
      }
      
      function clearMapMarkers(mapInstance, markerArray) {
        markerArray.forEach(marker => {
          if (mapInstance && mapInstance.hasLayer(marker)) {
            mapInstance.removeLayer(marker);
          }
        });
        markerArray.length = 0; // Clear the array
      }
      
      function updateRouteLine(mapInstance, path) {
        if (routeLine && mapInstance.hasLayer(routeLine)) {
          mapInstance.removeLayer(routeLine);
        }
        routeLine = L.polyline(path, { color: 'red', weight: 5 }).addTo(mapInstance);
        mapInstance.fitBounds(routeLine.getBounds());
      }
      function updateEmergencyRouteLine(mapInstance, path) {
        if (emergencyRouteLine && mapInstance.hasLayer(emergencyRouteLine)) {
          mapInstance.removeLayer(emergencyRouteLine);
        }
        emergencyRouteLine = L.polyline(path, { color: 'purple', weight: 5, dashArray: '10, 10' }).addTo(mapInstance);
        mapInstance.fitBounds(emergencyRouteLine.getBounds());
      }
      
      
      async function geocode(query) {
        try {
          const res = await fetch('/search-location', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query: query })
          });
          
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          const results = await res.json();
          if (!results || results.length === 0) {
            return null;
          }
          return { lat: parseFloat(results[0].lat), lng: parseFloat(results[0].lon), display_name: results[0].display_name };
        } catch (error) {
          console.error("Geocoding failed:", error);
          showToast(`Failed to find location: ${query}`, 'error');
          return null;
        }
      }
      
      function showToast(message, type = 'info') {
        const toastContainer = document.querySelector('.toast-container');
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : 'primary'} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
        `;
        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
      }
      
      // --- Location & Map Management ---
      function getCurrentLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            if (currentLocationMarker && map.hasLayer(currentLocationMarker)) {
              map.removeLayer(currentLocationMarker);
            }
            currentLocationMarker = addMarker(map, lat, lng, "Your Current Location", "green");
            map.setView([lat, lng], 14);
            showToast("Current location detected!", 'success');
            document.getElementById('originInput').value = `${lat},${lng}`; // Pre-fill origin
          },
          (error) => {
            console.error("Error getting location:", error);
            showToast("Could not retrieve your location. Please enable location services.", 'error');
          },
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
          );
        } else {
          showToast("Geolocation is not supported by your browser.", 'error');
        }
      }
      
      // --- Smart Route Suggestion Logic ---
      document.getElementById('getRouteBtn').addEventListener('click', async () => {
        const originQuery = document.getElementById('originInput').value;
        const destinationQuery = document.getElementById('destinationInput').value;
        const routeResultDiv = document.getElementById('routeResult');
        routeResultDiv.innerHTML = '<p>Calculating route...</p>';
        
        let originCoords = null;
        if (originQuery.includes(',')) { // Check if it's lat,lng
        const parts = originQuery.split(',').map(Number);
        originCoords = { lat: parts[0], lng: parts[1] };
      } else {
        const originLocation = await geocode(originQuery);
        if (originLocation) originCoords = { lat: originLocation.lat, lng: originLocation.lng };
      }
      
      const destinationLocation = await geocode(destinationQuery);
      if (!originCoords || !destinationLocation) {
        routeResultDiv.innerHTML = '<p style="color: red;">Please enter valid origin and destination.</p>';
        return;
      }
      
      try {
        const response = await fetch('/predict-route', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ origin: [originCoords.lat, originCoords.lng], destination: [destinationLocation.lat, destinationLocation.lng] })
        });
        const data = await response.json();
        
        if (data.status === 'success') {
          routeResultDiv.innerHTML = `
          <p>Distance: ${data.distance} km</p>
          <p>Estimated Duration: ${data.duration} minutes</p>
          `;
          const currentRouteMap = initializeMap('routeMap');
          clearMapMarkers(currentRouteMap, trafficMarkers); // Clear old traffic markers on route map
          addMarker(currentRouteMap, originCoords.lat, originCoords.lng, "Origin", "blue");
          addMarker(currentRouteMap, destinationLocation.lat, destinationLocation.lng, "Destination", "orange");
          updateRouteLine(currentRouteMap, data.path);
          showToast("Route calculated successfully!", 'success');
        } else {
          routeResultDiv.innerHTML = `<p style="color: red;">Error: ${data.message}</p>`;
          showToast(`Route calculation failed: ${data.message}`, 'error');
        }
      } catch (error) {
        console.error("Error fetching route:", error);
        routeResultDiv.innerHTML = `<p style="color: red;">Failed to connect to the server or calculate route.</p>`;
        showToast("Failed to connect to the server or calculate route.", 'error');
      }
    });
    
    // --- Peak Hours Travel Suggestion Logic ---
    const peakHoursLocationSelect = document.getElementById('peakHoursLocationSelect');
    const peakHoursRoadTypeSelect = document.getElementById('peakHoursRoadTypeSelect');
    const getPeakHoursReportBtn = document.getElementById('getPeakHoursReportBtn');
    const peakHoursReportResult = document.getElementById('peakHoursReportResult');
    const hourlyPredictionsChart = document.getElementById('hourlyPredictionsChart');
    
    // Function to load locations and road types for dropdowns
    async function loadPredictionData() {
      try {
        const response = await fetch('/get-prediction-data');
        const data = await response.json();
        if (data.status === 'success') {
          // Populate locations
          peakHoursLocationSelect.innerHTML = '';
          data.locations.forEach(loc => {
            const option = document.createElement('option');
            option.value = loc.value;
            option.textContent = loc.label;
            peakHoursLocationSelect.appendChild(option);
          });
          
          // Populate road types
          peakHoursRoadTypeSelect.innerHTML = '';
          data.road_types.forEach(road => {
            const option = document.createElement('option');
            option.value = road.value;
            option.textContent = road.label;
            peakHoursRoadTypeSelect.appendChild(option);
          });
        } else {
          showToast(`Error loading prediction data: ${data.message}`, 'error');
        }
      } catch (error) {
        console.error("Error fetching prediction data:", error);
        showToast(`Failed to load prediction data: ${error.message}`, 'error');
      }
    }
    
    // Event listener for the "Get Travel Suggestion" button
    getPeakHoursReportBtn.addEventListener('click', async () => {
      const location = peakHoursLocationSelect.value;
      const roadType = peakHoursRoadTypeSelect.value;
      const isWeekend = document.querySelector('input[name="dayType"]:checked').value;
      
      if (!location || !roadType || isWeekend === undefined) {
        showToast("Please select a location, road type, and day type.", 'warning');
        return;
      }
      
      peakHoursReportResult.innerHTML = '<p>Generating report...</p>';
      hourlyPredictionsChart.innerHTML = ''; // Clear previous chart
      
      try {
        const response = await fetch('/get-peak-hours-report', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            location: parseInt(location),
            road_type: parseInt(roadType),
            is_weekend: parseInt(isWeekend)
          }),
        });
        const data = await response.json();
        
        if (data.status === 'success') {
          peakHoursReportResult.innerHTML = `
          <h5>Travel Suggestions for ${data.location_name} - ${data.road_type_name} (${data.day_type_name})</h5>
          <p><strong>Best times to travel:</strong> <span class="text-success">${data.best_times || 'N/A'}</span></p>
          <p><strong>Times to avoid:</strong> <span class="text-danger">${data.avoid_times || 'N/A'}</span></p>
          `;
          renderHourlyPredictionsChart(data.hourly_predictions);
          showToast("Peak hours report generated!", 'success');
        } else {
          peakHoursReportResult.innerHTML = `<p class="text-danger">Error: ${data.message}</p>`;
          showToast(`Error generating report: ${data.message}`, 'error');
        }
      } catch (error) {
        console.error("Error fetching peak hours report:", error);
        peakHoursReportResult.innerHTML = `<p class="text-danger">Failed to generate report: ${error.message}</p>`;
        showToast(`Failed to generate report: ${error.message}`, 'error');
      }
    });
    
    // Function to render the hourly predictions chart
    function renderHourlyPredictionsChart(predictions) {
      hourlyPredictionsChart.innerHTML = '<h6>Hourly Traffic Predictions:</h6>';
      const chartContainer = document.createElement('div');
      chartContainer.className = 'd-flex justify-content-between align-items-end flex-wrap'; // Use flex-wrap for smaller screens
      chartContainer.style.height = '180px';
      chartContainer.style.borderBottom = '1px solid #ccc';
      chartContainer.style.paddingBottom = '5px';
      chartContainer.style.position = 'relative';
      
      const trafficLevelColors = {
        'Low': '#2ecc71', // Green
        'Moderate': '#f1c40f', // Yellow
        'High': '#e67e22', // Orange
        'Very High': '#e74c3c' // Red
      };
      // Determine max traffic level numerical value for scaling
      const maxTrafficValue = Math.max(...predictions.map(p => {
        // Map traffic levels to numerical values for chart scaling
        if (p.traffic_level === 'Low') return 1;
        if (p.traffic_level === 'Moderate') return 2;
        if (p.traffic_level === 'High') return 3;
        if (p.traffic_level === 'Very High') return 4;
        return 0;
      }));
      
      
      predictions.forEach(p => {
        const bar = document.createElement('div');
        bar.className = 'bar';
        bar.style.width = '30px'; // Make bars narrower for more hours
        bar.style.margin = '0 2px'; // Adjust margin
        bar.style.position = 'relative';
        
        let barHeight;
        let textColor = '#fff'; // Default text color for bars
        let trafficText = p.traffic_level;
        
        // Scale bar height based on traffic level
        if (p.traffic_level === 'Low') {
          barHeight = '25%';
          bar.style.backgroundColor = trafficLevelColors['Low'];
        } else if (p.traffic_level === 'Moderate') {
          barHeight = '50%';
          bar.style.backgroundColor = trafficLevelColors['Moderate'];
          textColor = '#333'; // Darker text for yellow background
        } else if (p.traffic_level === 'High') {
          barHeight = '75%';
          bar.style.backgroundColor = trafficLevelColors['High'];
        } else if (p.traffic_level === 'Very High') {
          barHeight = '100%';
          bar.style.backgroundColor = trafficLevelColors['Very High'];
        } else {
          barHeight = '10%'; // Default for unknown/N/A
          bar.style.backgroundColor = '#ccc';
          trafficText = 'N/A';
          textColor = '#333';
        }
        
        bar.style.height = barHeight;
        bar.style.color = textColor;
        
        
        const hourLabel = document.createElement('span');
        hourLabel.className = 'bar-label';
        hourLabel.textContent = p.hour;
        hourLabel.style.bottom = '-20px'; // Position below the bar
        hourLabel.style.width = '100%';
        hourLabel.style.textAlign = 'center';
        hourLabel.style.fontSize = '0.7em'; // Smaller font for hour labels
        hourLabel.style.color = '#555';
        
        const trafficLabel = document.createElement('span');
        trafficLabel.style.position = 'absolute';
        trafficLabel.style.top = '-15px'; // Position above the bar
        trafficLabel.style.width = '100%';
        trafficLabel.style.textAlign = 'center';
        trafficLabel.style.fontSize = '0.7em'; // Smaller font for traffic labels
        trafficLabel.textContent = trafficText;
        trafficLabel.style.color = textColor; // Use the determined text color
        
        bar.appendChild(trafficLabel);
        bar.appendChild(hourLabel);
        chartContainer.appendChild(bar);
      });
      hourlyPredictionsChart.appendChild(chartContainer);
    }
    
    // Initial load of prediction data when the page loads
    loadPredictionData();
    
    
    // --- Emergency Route Finder Logic ---
    document.getElementById('findEmergencyRouteBtn').addEventListener('click', async () => {
      const emergencyRouteResultDiv = document.getElementById('emergencyRouteResult');
      emergencyRouteResultDiv.innerHTML = '<p>Finding nearest emergency facility...</p>';
      
      if (!navigator.geolocation) {
        emergencyRouteResultDiv.innerHTML = '<p style="color: red;">Geolocation is not supported by your browser.</p>';
        showToast("Geolocation not supported.", 'error');
        return;
      }
      
      navigator.geolocation.getCurrentPosition(async (position) => {
        const currentLat = position.coords.latitude;
        const currentLng = position.coords.longitude;
        
        try {
          const response = await fetch('/emergency-routes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ current_location: [currentLat, currentLng] })
          });
          const data = await response.json();
          
          if (data.status === 'success') {
            emergencyRouteResultDiv.innerHTML = `
            <p>Nearest Facility: <strong>${data.destination.name}</strong> (${data.destination.type})</p>
            <p>Distance: ${data.distance.toFixed(2)} km</p>
            <p>Estimated Duration: ${data.duration.toFixed(0)} minutes</p>
            `;
            const currentEmergencyMap = initializeMap('emergencyMap');
            addMarker(currentEmergencyMap, currentLat, currentLng, "Your Location", "green");
            addMarker(currentEmergencyMap, data.destination.lat, data.destination.lng, data.destination.name, "red");
            updateEmergencyRouteLine(currentEmergencyMap, data.route);
            showToast(`Route to ${data.destination.name} found!`, 'success');
          } else {
            emergencyRouteResultDiv.innerHTML = `<p style="color: red;">Error: ${data.message}</p>`;
            showToast(`Emergency route failed: ${data.message}`, 'error');
          }
        } catch (error) {
          console.error("Error finding emergency route:", error);
          emergencyRouteResultDiv.innerHTML = `<p style="color: red;">Failed to connect to the server or find emergency route.</p>`;
          showToast("Failed to connect to the server or find emergency route.", 'error');
        }
      }, (error) => {
        console.error("Geolocation error:", error);
        emergencyRouteResultDiv.innerHTML = `<p style="color: red;">Could not get your location. Please enable location services.</p>`;
        showToast("Geolocation access denied or failed.", 'error');
      }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
    });
    
    
    // --- Traffic Signal Timing Predictor Logic ---
    const signalLocationSelect = document.getElementById('signalLocationSelect');
    const signalHourRange = document.getElementById('signalHourRange');
    const signalHourValueSpan = document.getElementById('signalHourValue');
    const predictSignalButton = document.getElementById('predictSignalButton');
    const signalPredictionResultsDiv = document.getElementById('signalPredictionResults');
    const signalChart = document.getElementById('signalChart');
    
    // Update hour value display
    signalHourRange.addEventListener('input', () => {
      signalHourValueSpan.textContent = signalHourRange.value;
    });
    
    // Fetch locations and populate the dropdown for signal predictor
    async function loadSignalLocations() {
      try {
        const response = await fetch('/get-signal-locations');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const locations = await response.json();
        signalLocationSelect.innerHTML = '<option value="">Select a location</option>'; // Clear existing and add default
        locations.forEach(loc => {
          const option = document.createElement('option');
          option.value = loc;
          option.textContent = loc;
          signalLocationSelect.appendChild(option);
        });
        if (locations.length > 0) {
          signalLocationSelect.value = locations[0]; // Select first one by default
        }
      } catch (error) {
        console.error('Error loading signal locations:', error);
        signalLocationSelect.innerHTML = '<option value="">Error loading locations</option>';
        showToast('Failed to load signal locations.', 'error');
      }
    }
    
    // Handle signal prediction button click
    predictSignalButton.addEventListener('click', async () => {
      const selectedLocation = signalLocationSelect.value;
      const selectedHour = parseInt(signalHourRange.value);
      const selectedDayType = document.querySelector('input[name="signalDayType"]:checked').value;
      
      if (!selectedLocation) {
        showToast('Please select a location for signal prediction.', 'error');
        return;
      }
      
      signalPredictionResultsDiv.innerHTML = '<h3>Predicting signal timings...</h3>';
      
      try {
        const response = await fetch('/predict-signal-timings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            location: selectedLocation,
            hour: selectedHour,
            day_type: selectedDayType
          })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
          const timings = data.signal_timings;
          let resultsHtml = `
          <h3><i class="fas fa-chart-bar"></i> Prediction Results for ${data.location}:</h3>
          <p class="signal-prediction-result-item"><span class="signal-prediction-result-label">Current Hour:</span> <span class="signal-prediction-result-value">${data.current_hour}</span></p>
          <p class="signal-prediction-result-item"><span class="signal-prediction-result-label">Day Type:</span> <span class="signal-prediction-result-value">${data.day_type}</span></p>
          <p class="signal-prediction-result-item"><span class="signal-prediction-result-label">Predicted Green Time:</span> <span class="signal-prediction-result-value">${timings.green} seconds</span></p>
          <p class="signal-prediction-result-item"><span class="signal-prediction-result-label">Predicted Red Time:</span> <span class="signal-prediction-result-value">${timings.red} seconds</span></p>
          <p class="signal-prediction-result-item"><span class="signal-prediction-result-label">Predicted Yellow Time:</span> <span class="signal-prediction-result-value">${timings.yellow} seconds</span></p>
          <p class="signal-prediction-result-item"><span class="signal-prediction-result-label">Confidence:</span> <span class="signal-prediction-result-value">${data.confidence}</span></p>
          `;
          signalPredictionResultsDiv.innerHTML = resultsHtml;
          
          // Render simple bar chart
          renderSignalChart(timings.green, timings.red, timings.yellow);
          showToast("Signal timings predicted!", 'success');
          
        } else {
          signalPredictionResultsDiv.innerHTML = `<p style="color: red;">Error: ${data.message || 'Unknown error'}</p>`;
          showToast(`Signal prediction failed: ${data.message || 'Unknown error'}`, 'error');
        }
      } catch (error) {
        console.error('Error fetching signal prediction:', error);
        signalPredictionResultsDiv.innerHTML = `<p style="color: red;">Failed to connect to the server or process request: ${error.message}</p>`;
        showToast(`Failed to fetch signal prediction: ${error.message}`, 'error');
      }
    });
    
    function renderSignalChart(green, red, yellow) {
      signalChart.innerHTML = ''; // Clear previous bars
      const maxTime = Math.max(green, red, yellow) + 15; // Add some padding for visualization
      
      const createBar = (label, value, className) => {
        const barDiv = document.createElement('div');
        barDiv.className = `bar ${className}`;
        barDiv.style.height = `${(value / maxTime) * 100}%`;
        barDiv.innerHTML = `<span>${value}s</span><span class="bar-label">${label}</span>`;
        return barDiv;
      };
      
      signalChart.appendChild(createBar('Green', green, 'green'));
      signalChart.appendChild(createBar('Red', red, 'red'));
      signalChart.appendChild(createBar('Yellow', yellow, 'yellow'));
    }
    
    
    // --- Voice Assistant Logic ---
    const micBtn = document.getElementById('micBtn');
    const voiceStatusDiv = document.getElementById('voiceStatus');
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    
    if (SpeechRecognition) {
      const recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.lang = 'en-IN'; // Indian English
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      
      micBtn.addEventListener('click', () => {
        voiceStatusDiv.textContent = 'Listening...';
        micBtn.classList.remove('btn-danger');
        micBtn.classList.add('btn-warning');
        recognition.start();
      });
      
      recognition.onresult = async (event) => {
        const command = event.results[0][0].transcript;
        voiceStatusDiv.textContent = `You said: "${command}"`;
        micBtn.classList.remove('btn-warning');
        micBtn.classList.add('btn-danger');
        
        try {
          const res = await fetch('/assistant-command', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ command })
          });
          
          if (res.ok) {
            const data = await res.json();
            voiceStatusDiv.textContent += `\nAssistant: ${data.message}`;
            speakText(data.message);
            
            if (data.intent === 'navigate' && data.destination) {
              document.getElementById('traffic-suggestion-content').classList.add('active');
              document.getElementById('dashboard-content').classList.remove('active'); // Hide dashboard
              document.querySelectorAll('.nav-link').forEach(navLink => navLink.classList.remove('active'));
              document.querySelector('[data-target="traffic-suggestion-content"]').classList.add('active');
              
              
              document.getElementById('destinationInput').value = data.destination;
              // Attempt to click the route button if destination is set by assistant
              setTimeout(() => {
                document.getElementById('getRouteBtn').click();
              }, 500); // Small delay to ensure UI update
            } else if (data.intent === 'traffic_query' && data.location) {
              showToast(`Checking traffic near ${data.location}.`, 'info');
            }
            
          } else {
            const errorData = await res.json();
            voiceStatusDiv.textContent += `\nAssistant Error: ${errorData.error}`;
            speakText(`Sorry, I couldn't process that. Error: ${errorData.error}`);
          }
        } catch (error) {
          console.error("Error sending command to assistant:", error);
          voiceStatusDiv.textContent += `\nAssistant Error: An internal error occurred.`;
          speakText("I apologize, an internal error occurred.");
        }
      };
      
      recognition.onerror = (event) => {
        voiceStatusDiv.textContent = `Speech recognition error: ${event.error}`;
        micBtn.classList.remove('btn-warning');
        micBtn.classList.add('btn-danger');
        speakText("Sorry, I didn't catch that. Please try again.");
      };
      
      recognition.onend = () => {
        if (!voiceStatusDiv.textContent.includes("You said:")) { // If no speech was detected
          voiceStatusDiv.textContent = 'Click the microphone to speak.';
        }
        micBtn.classList.remove('btn-warning');
        micBtn.classList.add('btn-danger');
      };
      
    } else {
      micBtn.disabled = true;
      voiceStatusDiv.textContent = 'Speech recognition not supported in this browser. Use Chrome for best experience.';
      speakText("Speech recognition is not supported in your browser.");
    }
    
    function speakText(text) {
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-IN'; // Indian English
        speechSynthesis.speak(utterance);
      } else {
        console.warn("Speech synthesis not supported in this browser.");
      }
    }
    
    // --- Alerts Logic ---
    async function loadAlerts() {
      const alertsListDiv = document.getElementById('alertsList');
      alertsListDiv.innerHTML = '<p>Loading alerts...</p>';
      try {
        const response = await fetch('/get-alerts');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const alerts = await response.json();
        if (alerts.length > 0) {
          alertsListDiv.innerHTML = ''; // Clear "Loading..."
          clearMapMarkers(map, alertMarkers); // Clear existing alert markers on main map
          
          alerts.forEach(alert => {
            const alertElement = document.createElement('div');
            alertElement.className = 'alert alert-warning';
            alertElement.innerHTML = `
            <strong>${alert.type.toUpperCase()}:</strong> ${alert.description} <br>
            Location: ${alert.location} (Severity: ${alert.severity})
            <small class="text-muted d-block">${new Date(alert.timestamp).toLocaleString()}</small>
            `;
            alertsListDiv.appendChild(alertElement);
            
            // Add marker to the main map for alerts
            if (map) {
              const alertMarker = addMarker(map, alert.lat, alert.lng, `${alert.type.toUpperCase()}: ${alert.location}`, 'orange');
              alertMarkers.push(alertMarker);
            }
          });
          showToast(`Loaded ${alerts.length} new alerts.`, 'info');
        } else {
          alertsListDiv.innerHTML = '<p>No active alerts.</p>';
          showToast('No active alerts found.', 'info');
        }
      } catch (error) {
        console.error("Error loading alerts:", error);
        alertsListDiv.innerHTML = `<p class="text-danger">Failed to load alerts: ${error.message}</p>`;
        showToast(`Failed to load alerts: ${error.message}`, 'error');
      }
    }
    
    // Initial loads when page is ready
    getCurrentLocation(); // Attempt to get current location for the dashboard map
    loadAlerts(); // Load alerts for the dashboard
    loadSignalLocations(); // Load locations for the signal predictor dropdown
  });
  
  
  
  // --- News Fetching and Display Logic ---
  
  async function fetchAndDisplayVadodaraNews() {
    const newsListContainer = document.getElementById('newsListContainer');
    newsListContainer.innerHTML = '<p class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading latest news...</p>';
    
    try {
      // This endpoint must match the one you create in your app.py
      const response = await fetch('/api/vadodara-news'); 
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const news = await response.json();
      
      if (news.length === 0) {
        newsListContainer.innerHTML = '<p class="text-center text-muted">No news updates available.</p>';
        return;
      }
      
      newsListContainer.innerHTML = ''; // Clear loading message
      
      news.forEach(item => {
        const newsItemDiv = document.createElement('div');
        newsItemDiv.className = 'news-item';
        
        const titleElem = document.createElement('h6');
        const linkElem = document.createElement('a');
        linkElem.href = item.link;
        linkElem.target = '_blank'; // Open in new tab
        linkElem.textContent = item.title;
        titleElem.appendChild(linkElem);
        newsItemDiv.appendChild(titleElem);
        
        if (item.summary) {
          const summaryElem = document.createElement('p');
          summaryElem.className = 'summary';
          // Limit summary length for display
          summaryElem.textContent = item.summary.substring(0, 150) + (item.summary.length > 150 ? '...' : '');
          newsItemDiv.appendChild(summaryElem);
        }
        
        if (item.published) {
          const publishedElem = document.createElement('p');
          publishedElem.className = 'published';
          publishedElem.textContent = new Date(item.published).toLocaleString(); // Format date nicely
          newsItemDiv.appendChild(publishedElem);
        }
        
        newsListContainer.appendChild(newsItemDiv);
      });
      
    } catch (error) {
      console.error("Error fetching Vadodara news:", error);
      newsListContainer.innerHTML = `<p class="text-center text-danger">Failed to load news: ${error.message}</p>`;
      showToast("Failed to load Vadodara news.", 'error');
    }
  }
  
  
  // New Feature of the Smart Route Planner  :
  // Function to handle the smart route form submission
  document.getElementById('smartRouteForm').addEventListener('submit', async function(event) {
    event.preventDefault(); // Prevent default form submission
    
    const startNode = document.getElementById('startNodeInput').value;
    const endNode = document.getElementById('endNodeInput').value;
    const hour = parseInt(document.getElementById('hourInput').value);
    
    const resultsDiv = document.getElementById('smartRouteResults');
    const errorDiv = document.getElementById('smartRouteError');
    const routeDistanceSpan = document.getElementById('routeDistance');
    const routeTimeSpan = document.getElementById('routeTime');
    const routePathSpan = document.getElementById('routePath');
    const routeSegmentsList = document.getElementById('routeSegments');
    
    resultsDiv.style.display = 'none'; // Hide previous results
    errorDiv.style.display = 'none'; // Hide previous errors
    routeSegmentsList.innerHTML = ''; // Clear previous segments
    
    try {
      const response = await fetch('/suggest-smart-route', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ start_node: startNode, end_node: endNode, hour: hour }),
      });
      
      const data = await response.json();
      
      if (response.ok) {
        routeDistanceSpan.textContent = data.total_distance_km;
        routeTimeSpan.textContent = data.estimated_time_min;
        routePathSpan.textContent = data.path_nodes.join(' → ');
        
        data.route_details.forEach(segment => {
          const listItem = document.createElement('li');
          listItem.classList.add('list-group-item');
          listItem.textContent = `${segment.from} → ${segment.to} (${segment.road_type}, ${segment.distance_km} km) - Est. ${segment.estimated_time_min} mins`;
          routeSegmentsList.appendChild(listItem);
        });
        
        resultsDiv.style.display = 'block'; // Show results
      } else {
        errorDiv.textContent = data.message || 'An unknown error occurred.';
        errorDiv.style.display = 'block'; // Show error
      }
    } catch (error) {
      console.error('Error fetching smart route:', error);
      errorDiv.textContent = 'Failed to connect to the server or process route. Please try again.';
      errorDiv.style.display = 'block'; // Show error
    }
  });
  
  
  
  
  // NOTE for Map Visualization:
  // To draw the route on the Leaflet map, you would need the geographical coordinates
  // (latitude and longitude) for each 'node' in your road network.
  // Your 'Vadodara_Smart_Route_Suggestions.csv' currently only defines node names.
  // You would either need to:
  // 1. Extend your road_network.csv (or a separate node_coordinates.csv) to include lat/lng for each node.
  // 2. Or, add a backend endpoint that can provide coordinates for given node names.
  // Once you have the coordinates, you can use Leaflet's L.polyline() to draw the path:
  /*
  function drawRouteOnMap(pathNodes, nodeCoordinatesMap) {
  if (window.currentRouteLayer) {
  window.map.removeLayer(window.currentRouteLayer); // Clear previous route
  }
  const latlngs = pathNodes.map(nodeName => {
  const coords = nodeCoordinatesMap[nodeName]; // Assume nodeCoordinatesMap is available {nodeName: [lat, lng]}
  return coords;
  }).filter(coord => coord); // Filter out any undefined coordinates
  
  if (latlngs.length > 1) {
  window.currentRouteLayer = L.polyline(latlngs, {color: 'blue', weight: 5}).addTo(window.map);
  window.map.fitBounds(window.currentRouteLayer.getBounds()); // Zoom to route
  }
  }
  // Example usage in response.ok block after fetching route:
  // if (data.path_nodes && window.map) {
  //     // You need to define 'nodeCoordinatesMap' here (e.g., by loading it from a file or backend)
  //     const nodeCoordinatesMap = {
  //         "Nizampura": [22.3323, 73.1818], // Example coordinates
  //         "Subhanpura": [22.3210, 73.1650],
  //         // ... all your nodes
  //     };
  //     drawRouteOnMap(data.path_nodes, nodeCoordinatesMap);
  // }
  */
  
  // for Live News JS code 
  /*const Parser = require('rss-parser');
  let parser = new Parser();
  
  async function getVadodaraNews() {
  const feedUrl = "https://sandesh.com/rss/vadodara-city.xml"; // Replace with the actual URL
  let feed = await parser.parseURL(feedUrl);
  const newsItems = feed.items.map(item => ({
  title: item.title,
  link: item.link,
  summary: item.contentSnippet || item.summary || '',
  published: item.pubDate || ''
  }));
  return newsItems;
  }*/
  
  // --- Function to Fetch Vadodara News from Flask Backend ---
  async function fetchVadodaraNews() {
    const newsContainer = document.getElementById('newsFeedContainer');
    if (!newsContainer) {
      console.warn("News feed container 'newsFeedContainer' not found.");
      return;
    }
    newsContainer.innerHTML = '<p class="text-muted">Loading latest news...</p>';
    
    try {
      const response = await fetch('/get-news'); // This calls your Flask endpoint
      const result = await response.json();
      
      if (response.ok && result.status === "success") {
        newsContainer.innerHTML = ''; // Clear loading message
        
        if (result.news && result.news.length > 0) {
          result.news.forEach(item => {
            const newsCard = document.createElement('div');
            newsCard.className = 'card mb-3';
            newsCard.innerHTML = `
                            <div class="card-body">
                                <h5 class="card-title">${item.title}</h5>
                                <p class="card-text">${item.summary}</p>
                                <a href="${item.link}" class="btn btn-sm btn-outline-primary" target="_blank">Read More</a>
                                <p class="card-text"><small class="text-muted">Published: ${new Date(item.published).toLocaleString()}</small></p>
                            </div>
                        `;
            newsContainer.appendChild(newsCard);
          });
        } else {
          newsContainer.innerHTML = '<p class="text-muted">No news available at the moment.</p>';
        }
      } else {
        newsContainer.innerHTML = '<p class="text-danger">Failed to load news: ' + (result.message || 'Unknown error') + '</p>';
        console.error("Failed to load news:", result);
      }
    } catch (error) {
      newsContainer.innerHTML = '<p class="text-danger">Network error: Could not load news.</p>';
      console.error("News fetch error:", error);
    }
  }
  
  
  // Display the Alert for Water logging :
  // --- Helper Function: showToast (Example - Customize or ensure yours is defined) ---
  // This function is crucial for displaying popup messages to the user.
  // Replace this with your actual toast notification implementation (e.g., using Bootstrap toasts).
  function showToast(message, type) {
    console.log(`Toast (${type}): ${message}`);
    // Example basic implementation for a simple alert, if you don't have Bootstrap toasts set up:
    // alert(`${type.toUpperCase()}: ${message}`); 
    
    // If you are using Bootstrap 5 toasts, your implementation might look like this:
    // const toastContainer = document.getElementById('toastContainer'); // Make sure you have a toast container in your HTML
    // if (!toastContainer) {
    //     console.warn('Toast container not found. Add <div id="toastContainer" class="toast-container position-fixed bottom-0 end-0 p-3"></div> to your HTML.');
    //     alert(`${type.toUpperCase()}: ${message}`);
    //     return;
    // }
    // const toastHtml = `
    //     <div class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
      //         <div class="d-flex">
        //             <div class="toast-body">
          //                 ${message}
          //             </div>
          //             <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          //         </div>
          //     </div>
          // `;
          // toastContainer.insertAdjacentHTML('beforeend', toastHtml);
          // const toastElement = toastContainer.lastElementChild;
          // const toast = new bootstrap.Toast(toastElement);
          // toast.show();
          // toastElement.addEventListener('hidden.bs.toast', function () {
          //     toastElement.remove(); // Clean up the toast element after it's hidden
          // });
        }
        // --- Helper function to show Bootstrap Toasts ---
        function showToast(message, type, duration = 4000) {
          const toastContainer = document.querySelector('.toast-container');
          if (!toastContainer) {
            console.warn('Toast container not found. Add <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 11"></div> to your body.');
            alert(message); // Fallback if no toast container
            return;
          }
          
          const toastElement = document.createElement('div');
          toastElement.className = `toast align-items-center text-white bg-${type} border-0`;
          toastElement.setAttribute('role', 'alert');
          toastElement.setAttribute('aria-live', 'assertive');
          toastElement.setAttribute('aria-atomic', 'true');
          toastElement.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
          toastContainer.appendChild(toastElement);
          
          const toast = new bootstrap.Toast(toastElement, { delay: duration });
          toast.show();
          
          // Remove toast element after it fades out to prevent accumulation
          toastElement.addEventListener('hidden.bs.toast', () => {
            toastElement.remove();
          });
        }
        
        // --- Function to fetch Smart Route from Backend ---
        // This function will now be called when the form is submitted
        async function fetchSmartRoute(event) {
          event.preventDefault(); // Prevent default form submission (stops page reload)
          
          showToast("Calculating optimal route...", "info");
          
          // IMPORTANT: Getting values from your HTML input IDs
          const startNode = document.getElementById('startNodeInput').value;
          const endNode = document.getElementById('endNodeInput').value;
          const hour = document.getElementById('hourInput').value;
          
          // Basic validation
          if (!startNode || !endNode || !hour) {
            showToast("Please fill in all route details (Start, End, Hour).", "warning");
            return;
          }
          
          try {
            const response = await fetch('/suggest-smart-route', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                start_node: startNode,
                end_node: endNode,
                hour: parseInt(hour, 10) // Convert hour to integer
              }),
            });
            
            const data = await response.json(); // Parse the JSON response
            
            // Get route results and error display elements
            const smartRouteResults = document.getElementById('smartRouteResults');
            const routeDistance = document.getElementById('routeDistance');
            const routeTime = document.getElementById('routeTime');
            const routePath = document.getElementById('routePath');
            const routeSegments = document.getElementById('routeSegments');
            const smartRouteError = document.getElementById('smartRouteError');
            
            // Get alerts container
            const alertsContainer = document.getElementById('waterLoggingAlertsContainer');
            if (alertsContainer) {
              alertsContainer.innerHTML = ''; // Clear existing alert cards
              alertsContainer.style.display = 'none'; // Hide by default
            }
            
            // Hide previous results and errors by default
            if (smartRouteResults) smartRouteResults.style.display = 'none';
            if (smartRouteError) smartRouteError.style.display = 'none';
            if (smartRouteError) smartRouteError.textContent = '';
            
            
            if (response.ok && data.status === "success") {
              showToast("Route calculated successfully!", "success");
              console.log("Route Data:", data); // For debugging in browser console
              
              // --- Display Route Details ---
              if (smartRouteResults) {
                smartRouteResults.style.display = 'block'; // Show results section
                if (routeDistance) routeDistance.textContent = data.total_distance_km;
                if (routeTime) routeTime.textContent = data.estimated_time_min;
                if (routePath) routePath.textContent = data.path_nodes.join(' → '); // Use arrow for path
                
                if (routeSegments) {
                  routeSegments.innerHTML = ''; // Clear previous segments
                  data.route_details.forEach(segment => {
                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item';
                    listItem.textContent = `${segment.start_node} to ${segment.end_node}: ${segment.distance_km} km (${segment.time_min} min)`;
                    routeSegments.appendChild(listItem);
                  });
                }
              }
              
              
              // --- Display Water Logging Alerts (from backend response) ---
              if (data.water_logging_alerts && data.water_logging_alerts.length > 0) {
                if (alertsContainer) { // Ensure the container exists
                  alertsContainer.style.display = 'block'; // Make it visible
                  
                  data.water_logging_alerts.forEach(alert => {
                    const alertCard = document.createElement('div');
                    alertCard.className = 'col-md-6 mb-3'; // Bootstrap grid for layout
                    alertCard.innerHTML = `
                                <div class="water-logging-card p-3 border rounded shadow-sm bg-light">
                                    <h5 class="location-name text-danger">${alert.location_name}</h5>
                                    <img src="${alert.image_url}" alt="Water logging at ${alert.location_name}" class="img-fluid mb-2 rounded">
                                    <p class="alert-message">${alert.message}</p>
                                    <small class="text-muted">Reported: ${new Date(alert.report_date).toLocaleString()}</small>
                                </div>
                            `;
                    alertsContainer.appendChild(alertCard);
                  });
                  showToast("Warning: Water logging detected on the route!", "danger", 8000); // Longer duration
                } else {
                  console.warn("Water logging alerts container not found in HTML!"); // Log a warning if element is missing
                  showToast("Warning: Water logging detected, but container for alerts not found in HTML. Check console.", "danger", 8000);
                }
              } else {
                if (alertsContainer) alertsContainer.style.display = 'none'; // Hide if no alerts
                showToast("No water logging alerts found on this route.", "info");
              }
              
            } else {
              // Handle non-200 responses or status not 'success'
              const errorMessage = data.error || data.message || 'Unknown error occurred while fetching route.';
              showToast(`Error fetching route: ${errorMessage}`, "danger");
              console.error("Route Error:", data);
              
              if (smartRouteError) {
                smartRouteError.textContent = errorMessage;
                smartRouteError.style.display = 'block'; // Show error div
              }
              if (smartRouteResults) smartRouteResults.style.display = 'none'; // Hide results
              if (alertsContainer) alertsContainer.style.display = 'none'; // Hide alerts
            }
          } catch (error) {
            showToast("Network error or server unreachable. Please check your connection.", "danger");
            console.error("Fetch Error:", error);
            if (smartRouteError) {
              smartRouteError.textContent = "Network error: Could not connect to the server.";
              smartRouteError.style.display = 'block';
            }
            if (smartRouteResults) smartRouteResults.style.display = 'none';
            if (alertsContainer) alertsContainer.style.display = 'none';
          }
        }
        
        
        // --- Event Listeners for Page Load and Form Submissions ---
        document.addEventListener('DOMContentLoaded', function() {
          // --- Handle Smart Route Form Submission ---
          const smartRouteForm = document.getElementById('smartRouteForm'); // Get the form by its ID
          if (smartRouteForm) {
            smartRouteForm.addEventListener('submit', fetchSmartRoute); // Attach fetchSmartRoute to form submission
          } else {
            console.warn("Smart Route Form with ID 'smartRouteForm' not found. Route calculation might not be triggered.");
          }
          
          // --- Handle Water Hazard Report Form Submission ---
          const reportForm = document.getElementById('waterHazardReportForm'); // Ensure your form has this ID
          if (reportForm) {
            reportForm.addEventListener('submit', async function(event) {
              event.preventDefault(); // Prevent default form submission
              
              showToast("Submitting report...", "info");
              
              const formData = new FormData(this);
              
              try {
                const response = await fetch('/report-water-hazard', {
                  method: 'POST',
                  body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) { // Check if HTTP status is 2xx
                  showToast(result.message, "success");
                  reportForm.reset(); // Clear the form fields on success
                } else {
                  // Handle server-side errors
                  showToast(result.message || "An unknown error occurred during report submission.", "danger");
                  console.error("Report submission error:", result);
                }
              } catch (error) {
                showToast("Network error: Could not connect to the server for hazard report.", "danger");
                console.error("Form submission network error:", error);
              }
            });
          }
        });
      </script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    </body>
    </html>
